<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EL TACHI - Pedidos Online</title>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#1E40AF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EL TACHI">
    <meta name="description" content="Ped√≠ online de EL TACHI - Comida r√°pida y deliciosa">
    <meta name="keywords" content="comida r√°pida, pedidos online, hamburguesas, rotiser√≠a">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231E40AF'/%3E%3Ctext x='50' y='70' font-family='Arial' font-size='60' text-anchor='middle' fill='%23FBBF24'%3ET%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231E40AF'/%3E%3Ctext x='50' y='70' font-family='Arial' font-size='60' text-anchor='middle' fill='%23FBBF24'%3ET%3C/text%3E%3C/svg%3E">
    
    <!-- Styles -->
    <style>
        /* CSS Optimizado - Solo lo esencial */
        :root {
            --primary: #1E40AF;
            --secondary: #FBBF24;
            --primary-light: #60A5FA;
            --secondary-light: #FDE68A;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-600: #4B5563;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* App Container */
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #3730A3 100%);
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            padding-top: max(1rem, env(safe-area-inset-top));
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: var(--secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.5rem;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .header-info {
            flex: 1;
            min-width: 0;
        }
        
        .header-info h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            width: fit-content;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-badge.open .status-dot {
            background: #34D399;
        }
        
        .status-badge.closed .status-dot {
            background: #F87171;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            animation: fadeInUp 0.3s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.bot {
            background: var(--primary);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        
        .message.user {
            background: var(--secondary);
            color: var(--gray-900);
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        
        /* Product Cards */
        .product-card {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            margin: 0.5rem 0;
            border: 2px solid var(--primary-light);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .product-card:active {
            transform: scale(0.98);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .product-title {
            color: var(--primary);
            font-weight: 700;
            font-size: 1rem;
            flex: 1;
        }
        
        .product-price {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .product-description {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .product-toppings {
            font-size: 0.75rem;
            color: var(--gray-600);
            background: var(--secondary-light);
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.5rem 0;
        }
        
        .quick-btn {
            background: var(--primary-light);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            touch-action: manipulation;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
        }
        
        .quick-btn:hover {
            background: var(--primary);
        }
        
        /* Input Area */
        .input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
            position: sticky;
            bottom: 0;
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .input-field {
            width: 100%;
            min-height: 44px;
            max-height: 120px;
            padding: 0.625rem 1rem;
            padding-right: 2.5rem;
            border: 2px solid var(--primary-light);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            background: var(--gray-50);
            transition: var(--transition);
            -webkit-appearance: none;
            appearance: none;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .input-field::placeholder {
            color: var(--gray-600);
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            background: var(--secondary);
            color: var(--gray-900);
            border: none;
            border-radius: var(--radius);
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .send-btn:active {
            transform: scale(0.95);
            background: #F59E0B;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(30, 64, 175, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--gray-200);
            border-radius: 1rem;
            width: fit-content;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray-600);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Order Summary */
        .order-summary {
            background: linear-gradient(135deg, #DBEAFE 0%, #FEF3C7 100%);
            border-radius: var(--radius);
            padding: 1rem;
            margin: 0.5rem 0;
            border: 2px dashed var(--primary);
        }
        
        .order-summary h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary) 0%, #3730A3 100%);
            color: white;
            padding: 1rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideUp 0.5s ease;
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .install-content {
            flex: 1;
        }
        
        .install-content strong {
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .install-content p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .install-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .install-btn {
            background: var(--secondary);
            color: var(--gray-900);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .close-install {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        
        /* Admin Button */
        .admin-btn {
            background: var(--secondary);
            color: var(--gray-900);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--gray-600);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        
        .cursor-pointer {
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 500px) {
            .app-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .message {
                max-width: 90%;
            }
            
            .header {
                border-radius: 0;
            }
            
            .install-prompt {
                bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
        
        @media (max-height: 600px) {
            .header {
                padding: 0.75rem;
            }
            
            .chat-container {
                padding: 0.75rem;
            }
            
            .input-area {
                padding: 0.75rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .input-area,
            .install-prompt,
            .admin-btn {
                display: none !important;
            }
            
            .app-container {
                max-width: 100%;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Install Prompt -->
        <div id="installPrompt" class="install-prompt hidden">
            <div class="install-content">
                <strong>Instala EL TACHI</strong>
                <p>Para una mejor experiencia, instala nuestra app</p>
            </div>
            <div class="install-actions">
                <button id="installBtn" class="install-btn">Instalar</button>
                <button id="closeInstall" class="close-install">√ó</button>
            </div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <div class="logo">T</div>
            <div class="header-info">
                <h1 id="businessName">EL TACHI</h1>
                <div id="statusIndicator" class="status-badge">
                    <span class="status-dot"></span>
                    <span id="statusText">Cargando...</span>
                </div>
            </div>
            <a href="admin-completo.html" class="admin-btn" target="_blank" rel="noopener">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Admin
            </a>
        </header>
        
        <!-- Chat Container -->
        <main class="chat-container" id="chatContainer">
            <!-- Messages will be inserted here by JavaScript -->
            <div class="empty-state" id="emptyState">
                <div>üí¨</div>
                <p>Inicia una conversaci√≥n con nuestro asistente</p>
            </div>
        </main>
        
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Escribe tu mensaje..." 
                    rows="1"
                    autocomplete="off"
                    spellcheck="true"
                    aria-label="Mensaje"
                ></textarea>
            </div>
            <button id="sendButton" class="send-btn" aria-label="Enviar mensaje">
                <span id="sendIcon">‚û§</span>
                <span id="loadingIcon" class="loading hidden"></span>
            </button>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // ========== CONFIGURACI√ìN ==========
        const CONFIG = {
            apiBase: 'TU_URL_DE_APPS_SCRIPT_AQUI', // Reemplazar con tu URL
            version: '3.0.0',
            debounceDelay: 300,
            maxMessageLength: 1000,
            cacheDuration: 5 * 60 * 1000 // 5 minutos
        };
        
        // ========== ESTADO DE LA APLICACI√ìN ==========
        const AppState = {
            conversationId: localStorage.getItem('tachi_conversation_id') || generateId(),
            cart: JSON.parse(localStorage.getItem('tachi_cart')) || [],
            userData: JSON.parse(localStorage.getItem('tachi_user_data')) || {},
            businessHours: null,
            isOpen: false,
            isLoading: false,
            deferredPrompt: null,
            currentStep: 'welcome',
            messageQueue: [],
            processingQueue: false
        };
        
        // ========== CACHE LOCAL ==========
        const LocalCache = {
            get: (key) => {
                const item = localStorage.getItem(`tachi_cache_${key}`);
                if (!item) return null;
                
                const { value, expiry } = JSON.parse(item);
                if (expiry && Date.now() > expiry) {
                    localStorage.removeItem(`tachi_cache_${key}`);
                    return null;
                }
                
                return value;
            },
            
            set: (key, value, duration = CONFIG.cacheDuration) => {
                const item = {
                    value: value,
                    expiry: Date.now() + duration
                };
                localStorage.setItem(`tachi_cache_${key}`, JSON.stringify(item));
            },
            
            remove: (key) => {
                localStorage.removeItem(`tachi_cache_${key}`);
            },
            
            clear: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('tachi_cache_')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        };
        
        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeApp();
                setupEventListeners();
                setupServiceWorker();
                checkPWAInstall();
                
                // Cargar estado inicial
                await loadBusinessHours();
                await sendWelcomeMessage();
                
                // Mostrar notificaci√≥n de bienvenida
                showToast('¬°Bienvenido a EL TACHI!', 'success');
                
            } catch (error) {
                console.error('Error inicializando app:', error);
                showToast('Error al cargar la aplicaci√≥n', 'error');
            }
        });
        
        async function initializeApp() {
            // Guardar conversationId
            localStorage.setItem('tachi_conversation_id', AppState.conversationId);
            
            // Configurar textarea auto-expandible
            const textarea = document.getElementById('messageInput');
            setupTextarea(textarea);
            
            // Verificar conexi√≥n
            await checkConnection();
            
            // Configurar Intersection Observer para lazy loading
            setupIntersectionObserver();
            
            // Configurar beforeunload para guardar estado
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('tachi_cart', JSON.stringify(AppState.cart));
                localStorage.setItem('tachi_user_data', JSON.stringify(AppState.userData));
            });
        }
        
        function setupTextarea(textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // Atajos de teclado
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    this.focus();
                }
            });
            
            // Auto-focus en mobile
            if ('virtualKeyboard' in navigator) {
                textarea.addEventListener('focus', () => {
                    setTimeout(() => {
                        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            }
        }
        
        async function checkConnection() {
            if (!navigator.onLine) {
                showToast('Sin conexi√≥n a internet', 'warning');
                return false;
            }
            
            try {
                const response = await fetch(`${CONFIG.apiBase}?path=health`, {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: AbortSignal.timeout(5000)
                });
                
                return response.ok;
            } catch {
                return false;
            }
        }
        
        // ========== MANEJO DE HORARIOS ==========
        async function loadBusinessHours() {
            try {
                const cached = LocalCache.get('business_hours');
                if (cached) {
                    updateBusinessStatus(cached);
                    return;
                }
                
                const response = await fetch(`${CONFIG.apiBase}?path=business-hours`);
                const data = await response.json();
                
                LocalCache.set('business_hours', data, 60000); // 1 minuto cache
                updateBusinessStatus(data);
                
            } catch (error) {
                console.error('Error cargando horarios:', error);
                updateBusinessStatus({
                    is_open: false,
                    message: 'Error cargando informaci√≥n'
                });
            }
        }
        
        function updateBusinessStatus(data) {
            AppState.businessHours = data;
            AppState.isOpen = data.is_open;
            
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDot = statusIndicator.querySelector('.status-dot');
            
            if (data.is_open) {
                statusIndicator.classList.add('open');
                statusIndicator.classList.remove('closed');
                statusText.textContent = 'Abierto ahora';
                statusDot.style.background = '#10B981';
            } else {
                statusIndicator.classList.add('closed');
                statusIndicator.classList.remove('open');
                statusText.textContent = 'Cerrado';
                statusDot.style.background = '#EF4444';
            }
        }
        
        // ========== MENSAJES INICIALES ==========
        async function sendWelcomeMessage() {
            if (!AppState.isOpen) {
                addMessage(AppState.businessHours.message, 'bot');
                return;
            }
            
            addMessage('¬°Hola! üëã Soy el asistente de EL TACHI. ¬øEn qu√© puedo ayudarte hoy?', 'bot');
            
            // Cargar y mostrar men√∫ despu√©s de un breve delay
            setTimeout(async () => {
                await showMenu();
            }, 1000);
        }
        
        async function showMenu() {
            try {
                const cached = LocalCache.get('products');
                let products;
                
                if (cached) {
                    products = cached;
                } else {
                    const response = await fetch(`${CONFIG.apiBase}?path=products`);
                    const data = await response.json();
                    products = data.products || [];
                    LocalCache.set('products', products);
                }
                
                if (!products.length) {
                    addMessage('El men√∫ no est√° disponible en este momento. Por favor, intenta m√°s tarde.', 'bot');
                    return;
                }
                
                const config = await getConfig();
                
                let menuMessage = `<strong>üìã NUESTRA CARTA</strong>\n\n`;
                
                // Agrupar por categor√≠a
                const byCategory = {};
                products.forEach(product => {
                    if (!byCategory[product.categoria]) {
                        byCategory[product.categoria] = [];
                    }
                    byCategory[product.categoria].push(product);
                });
                
                Object.entries(byCategory).forEach(([category, items]) => {
                    menuMessage += `<strong>${category.toUpperCase()}</strong>\n`;
                    
                    items.forEach(product => {
                        menuMessage += `‚Ä¢ <strong>${product.nombre}</strong> - $${product.precio.toFixed(2)}\n`;
                        if (product.descripcion) {
                            menuMessage += `  <small>${product.descripcion}</small>\n`;
                        }
                        if (product.aderezos_disponibles?.length > 0) {
                            menuMessage += `  üßÇ Aderezos: ${product.aderezos_disponibles.join(', ')}\n`;
                        }
                        menuMessage += `  <button class="quick-btn" onclick="selectProduct(${product.id})" style="margin-top: 0.25rem;">A√±adir al pedido</button>\n\n`;
                    });
                });
                
                menuMessage += `\n<strong>üì¶ ENV√çOS:</strong> $${config.delivery_fee || '2.50'}\n`;
                menuMessage += `<strong>‚è±Ô∏è TIEMPO:</strong> ${config.estimated_time || '30-45'} minutos\n`;
                menuMessage += `<strong>üìç RETIRO:</strong> ${config.pickup_available ? 'Disponible' : 'No disponible'}\n\n`;
                menuMessage += `Puedes personalizar cualquier producto. ¬øQu√© te gustar√≠a ordenar?`;
                
                addMessage(menuMessage, 'bot');
                
                // Agregar acciones r√°pidas
                addQuickActions([
                    { text: 'üõí Ver mi pedido', action: () => showCart() },
                    { text: 'üìû Contactar', action: () => showContactInfo() },
                    { text: '‚ùì Ayuda', action: () => showHelp() }
                ]);
                
            } catch (error) {
                console.error('Error mostrando men√∫:', error);
                addMessage('Lo siento, hubo un error al cargar el men√∫. Por favor, intenta de nuevo.', 'bot');
            }
        }
        
        async function getConfig() {
            const cached = LocalCache.get('config');
            if (cached) return cached;
            
            try {
                const response = await fetch(`${CONFIG.apiBase}?path=config`);
                const config = await response.json();
                LocalCache.set('config', config);
                return config;
            } catch {
                return {
                    delivery_fee: '2.50',
                    estimated_time: '30-45',
                    pickup_available: true
                };
            }
        }
        
        // ========== MANEJO DEL CARRITO ==========
        function selectProduct(productId) {
            // En una implementaci√≥n real, aqu√≠ se abrir√≠a un modal para personalizar
            addMessage(`Producto ${productId} seleccionado. Pronto podr√°s personalizarlo.`, 'bot');
            
            // Simular adici√≥n al carrito
            const product = {
                id: productId,
                name: `Producto ${productId}`,
                price: 10.99,
                quantity: 1,
                customization: 'Personalizaci√≥n est√°ndar'
            };
            
            AppState.cart.push(product);
            showToast('Producto a√±adido al carrito', 'success');
        }
        
        function showCart() {
            if (AppState.cart.length === 0) {
                addMessage('Tu carrito est√° vac√≠o.', 'bot');
                return;
            }
            
            let cartMessage = `<strong>üõí TU PEDIDO</strong>\n\n`;
            let total = 0;
            
            AppState.cart.forEach((item, index) => {
                cartMessage += `${index + 1}. ${item.name} x${item.quantity}\n`;
                if (item.customization) {
                    cartMessage += `   üìù ${item.customization}\n`;
                }
                cartMessage += `   $${(item.price * item.quantity).toFixed(2)}\n\n`;
                total += item.price * item.quantity;
            });
            
            cartMessage += `<strong>Total: $${total.toFixed(2)}</strong>\n\n`;
            
            if (AppState.userData.name) {
                cartMessage += `üë§ ${AppState.userData.name}\n`;
            }
            if (AppState.userData.phone) {
                cartMessage += `üìû ${AppState.userData.phone}\n`;
            }
            
            addMessage(cartMessage, 'bot');
            
            addQuickActions([
                { text: '‚úÖ Confirmar pedido', action: () => confirmOrder(total) },
                { text: '‚úèÔ∏è Editar pedido', action: () => editOrder() },
                { text: 'üóëÔ∏è Vaciar carrito', action: () => clearCart() }
            ]);
        }
        
        function clearCart() {
            AppState.cart = [];
            showToast('Carrito vaciado', 'info');
            addMessage('Carrito vaciado. ¬øQu√© te gustar√≠a ordenar?', 'bot');
        }
        
        // ========== FUNCIONES DE CONTACTO Y AYUDA ==========
        function showContactInfo() {
            getConfig().then(config => {
                const message = `
<strong>üìû CONTACTO EL TACHI</strong>

üìç Direcci√≥n: ${config.DIRECCION_LOCAL || 'Av. Siempre Viva 123'}
üì± Tel√©fono: ${config.TELEFONO_CONTACTO || '+5491112345678'}
‚è∞ Horario: Lunes a Domingo 10:00 - 23:00

¬øEn qu√© m√°s puedo ayudarte?
                `.trim();
                
                addMessage(message, 'bot');
            });
        }
        
        function showHelp() {
            const message = `
<strong>‚ùì AYUDA - EL TACHI</strong>

Puedo ayudarte con:
1. üìã Ver el men√∫ completo
2. üõí Hacer un pedido
3. üì¶ Consultar estado de pedido
4. üìû Ver informaci√≥n de contacto
5. ‚è∞ Consultar horarios

¬øEn qu√© necesitas ayuda?
            `.trim();
            
            addMessage(message, 'bot');
        }
        
        // ========== MANEJO DE MENSAJES ==========
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || AppState.isLoading || message.length > CONFIG.maxMessageLength) {
                return;
            }
            
            // Agregar mensaje del usuario
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';
            
            // Mostrar indicador de typing
            showTypingIndicator();
            
            // Enviar a la API
            AppState.isLoading = true;
            updateSendButton(true);
            
            try {
                const response = await fetch(`${CONFIG.apiBase}?path=gemini-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Conversation-ID': AppState.conversationId
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: AppState.conversationId,
                        order_context: JSON.stringify({
                            cart: AppState.cart,
                            userData: AppState.userData,
                            step: AppState.currentStep
                        })
                    }),
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remover indicador de typing
                removeTypingIndicator();
                
                // Agregar respuesta
                addMessage(data.response, 'bot');
                
                // Actualizar cache si hay productos
                if (data.products && data.products.length > 0) {
                    LocalCache.set('products', data.products);
                }
                
                // Procesar acciones especiales en la respuesta
                processBotResponse(data.response);
                
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                
                removeTypingIndicator();
                
                if (error.name === 'AbortError') {
                    addMessage('Lo siento, la solicitud tard√≥ demasiado. Por favor, intenta de nuevo.', 'bot');
                } else if (!navigator.onLine) {
                    addMessage('Parece que no tienes conexi√≥n a internet. Por favor, verifica tu conexi√≥n.', 'bot');
                } else {
                    addMessage('Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.', 'bot');
                }
                
            } finally {
                AppState.isLoading = false;
                updateSendButton(false);
                input.focus();
            }
        }
        
        function processBotResponse(response) {
            // Extraer y procesar informaci√≥n especial del bot
            // Esto puede incluir: datos del cliente, resumen de pedido, etc.
            
            // Ejemplo: Detectar si el bot est√° pidiendo datos del cliente
            const lowerResponse = response.toLowerCase();
            
            if (lowerResponse.includes('nombre') && !lowerResponse.includes('ya tengo')) {
                AppState.currentStep = 'asking_name';
            } else if (lowerResponse.includes('tel√©fono') || lowerResponse.includes('telefono')) {
                AppState.currentStep = 'asking_phone';
            } else if (lowerResponse.includes('direcci√≥n') || lowerResponse.includes('direccion')) {
                AppState.currentStep = 'asking_address';
            } else if (lowerResponse.includes('resumen') && lowerResponse.includes('total')) {
                AppState.currentStep = 'order_summary';
                
                // Extraer total del mensaje
                const totalMatch = response.match(/\$\s*([0-9]+(?:\.[0-9]{2})?)/);
                if (totalMatch) {
                    const total = parseFloat(totalMatch[1]);
                    addQuickActions([
                        { text: '‚úÖ Confirmar pedido', action: () => confirmOrder(total) },
                        { text: '‚úèÔ∏è Editar pedido', action: () => editOrder() }
                    ]);
                }
            }
        }
        
        // ========== INTERFAZ DE USUARIO ==========
        function addMessage(content, sender) {
            const container = document.getElementById('chatContainer');
            const emptyState = document.getElementById('emptyState');
            
            // Ocultar empty state si existe
            if (emptyState && !emptyState.classList.contains('hidden')) {
                emptyState.classList.add('hidden');
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = formatMessage(content);
            
            container.appendChild(messageDiv);
            
            // Scroll suave al final
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            // Animar entrada
            messageDiv.style.animation = 'fadeInUp 0.3s ease';
        }
        
        function formatMessage(content) {
            // Reemplazar saltos de l√≠nea
            let formatted = content.replace(/\n/g, '<br>');
            
            // Convertir URLs a enlaces
            formatted = formatted.replace(
                /(https?:\/\/[^\s]+)/g,
                '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );
            
            // Convertir n√∫meros de tel√©fono a enlaces
            formatted = formatted.replace(
                /(\+?[\d\s\-\(\)]{8,})/g,
                '<a href="tel:$1">$1</a>'
            );
            
            return formatted;
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            container.appendChild(typingDiv);
            
            // Scroll al indicador
            setTimeout(() => {
                typingDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function addQuickActions(actions) {
            const container = document.getElementById('chatContainer');
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'quick-actions';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'quick-btn';
                button.innerHTML = action.text;
                button.onclick = action.action;
                button.type = 'button';
                actionsDiv.appendChild(button);
            });
            
            container.appendChild(actionsDiv);
            
            // Scroll a las acciones
            setTimeout(() => {
                actionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function updateSendButton(loading) {
            const sendIcon = document.getElementById('sendIcon');
            const loadingIcon = document.getElementById('loadingIcon');
            const sendButton = document.getElementById('sendButton');
            
            if (loading) {
                sendIcon.classList.add('hidden');
                loadingIcon.classList.remove('hidden');
                sendButton.disabled = true;
            } else {
                sendIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                sendButton.disabled = false;
            }
        }
        
        function showToast(message, type = 'info') {
            // Implementaci√≥n simple de toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ========== CONFIRMACI√ìN DE PEDIDO ==========
        async function confirmOrder(total) {
            // Validar que tengamos datos del cliente
            if (!AppState.userData.name || !AppState.userData.phone) {
                addMessage('Necesito algunos datos antes de confirmar el pedido.', 'bot');
                return;
            }
            
            // Crear objeto de pedido
            const order = {
                nombre_cliente: AppState.userData.name,
                telefono: AppState.userData.phone,
                tipo_pedido: AppState.userData.deliveryType || 'retiro',
                direccion: AppState.userData.address || '',
                pedido_detallado: generateOrderDetails(),
                total: total.toFixed(2),
                notas: AppState.userData.notes || ''
            };
            
            try {
                addMessage('Procesando tu pedido...', 'bot');
                
                const response = await fetch(`${CONFIG.apiBase}?path=create-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(order)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mostrar confirmaci√≥n
                    const confirmation = `
<strong>‚úÖ PEDIDO CONFIRMADO</strong>

ID del pedido: ${result.order_id}
Estado: Recibido
Tiempo estimado: ${result.estimated_time}

Puedes seguir el estado de tu pedido con el ID: <strong>${result.order_id}</strong>

¬°Gracias por tu compra! üéâ
                    `.trim();
                    
                    addMessage(confirmation, 'bot');
                    
                    // Limpiar carrito
                    AppState.cart = [];
                    localStorage.removeItem('tachi_cart');
                    
                    // Reiniciar estado
                    AppState.userData = {};
                    AppState.currentStep = 'welcome';
                    
                    showToast('¬°Pedido confirmado exitosamente!', 'success');
                    
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error confirmando pedido:', error);
                addMessage('Lo siento, hubo un error al procesar tu pedido. Por favor, intenta de nuevo.', 'bot');
                showToast('Error al confirmar pedido', 'error');
            }
        }
        
        function generateOrderDetails() {
            let details = 'Pedido:\n';
            AppState.cart.forEach((item, index) => {
                details += `- ${item.name} x${item.quantity}`;
                if (item.customization) {
                    details += ` (${item.customization})`;
                }
                details += '\n';
            });
            return details;
        }
        
        // ========== PWA INSTALL ==========
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker registrado:', registration);
                        })
                        .catch(error => {
                            console.log('Service Worker registro fall√≥:', error);
                        });
                });
            }
        }
        
        function checkPWAInstall() {
            // Verificar si ya est√° instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            
            // Mostrar prompt despu√©s de 30 segundos
            setTimeout(() => {
                const prompt = document.getElementById('installPrompt');
                prompt.classList.remove('hidden');
            }, 30000);
        }
        
        // Event listeners para PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            AppState.deferredPrompt = e;
            
            const prompt = document.getElementById('installPrompt');
            prompt.classList.remove('hidden');
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!AppState.deferredPrompt) return;
            
            AppState.deferredPrompt.prompt();
            const { outcome } = await AppState.deferredPrompt.userChoice;
            
            console.log(`Usuario ${outcome} la instalaci√≥n`);
            
            AppState.deferredPrompt = null;
            document.getElementById('installPrompt').classList.add('hidden');
        });
        
        document.getElementById('closeInstall').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.add('hidden');
        });
        
        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Bot√≥n enviar
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            
            // Input field
            const input = document.getElementById('messageInput');
            input.addEventListener('input', debounce(() => {
                // Validar longitud
                if (input.value.length > CONFIG.maxMessageLength) {
                    input.value = input.value.substring(0, CONFIG.maxMessageLength);
                    showToast(`Mensaje limitado a ${CONFIG.maxMessageLength} caracteres`, 'warning');
                }
            }, CONFIG.debounceDelay));
            
            // Detectar cambios en conexi√≥n
            window.addEventListener('online', () => {
                showToast('Conexi√≥n restablecida', 'success');
                loadBusinessHours();
            });
            
            window.addEventListener('offline', () => {
                showToast('Sin conexi√≥n a internet', 'warning');
            });
            
            // Detectar cambios en visibilidad
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // App vuelve a ser visible
                    loadBusinessHours();
                }
            });
            
            // Prevenir zoom con doble tap en iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (event) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }
        
        // ========== UTILIDADES ==========
        function generateId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function setupIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Lazy load content
                        entry.target.classList.add('loaded');
                    }
                });
            }, options);
            
            // Observar elementos que necesiten lazy loading
            document.querySelectorAll('.lazy').forEach(el => observer.observe(el));
        }
        
        // ========== EXPORTAR FUNCIONES GLOBALES ==========
        window.selectProduct = selectProduct;
        window.showCart = showCart;
        window.showContactInfo = showContactInfo;
        window.showHelp = showHelp;
        window.confirmOrder = confirmOrder;
        window.clearCart = clearCart;
        window.sendMessage = sendMessage;
        
        // ========== DEBUG ==========
        if (window.location.hash === '#debug') {
            window.AppState = AppState;
            window.LocalCache = LocalCache;
            console.log('Modo debug activado');
        }
    </script>
</body>
</html>