<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup EL TACHI - Corregido</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; min-height: 100vh; padding: 40px 20px; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .logo { text-align: center; margin-bottom: 40px; }
        .logo-circle { width: 100px; height: 100px; background: #f59e0b; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: #1e40af; }
        h1 { text-align: center; font-size: 36px; margin-bottom: 10px; }
        .step { background: rgba(255, 255, 255, 0.15); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 2px solid rgba(255, 255, 255, 0.2); }
        .step-number { display: inline-block; background: #f59e0b; color: #1e40af; width: 36px; height: 36px; border-radius: 50%; text-align: center; line-height: 36px; font-weight: bold; margin-right: 12px; margin-bottom: 16px; }
        .code-block { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; font-family: 'Courier New', monospace; margin: 16px 0; overflow-x: auto; }
        .button { display: inline-block; background: #f59e0b; color: #1e40af; border: none; border-radius: 12px; padding: 16px 32px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: transform 0.2s; }
        .button:hover { transform: translateY(-2px); }
        .success { background: #10b981; color: white; }
        .error { background: #ef4444; color: white; }
        .status { padding: 12px 20px; border-radius: 12px; margin-top: 16px; display: none; }
        .status.show { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo">
            <div class="logo-circle">T</div>
            <h1>EL TACHI</h1>
            <p>Setup Corregido - Paso a Paso</p>
        </div>
        
        <div class="step">
            <div class="step-number">1</div>
            <h3>Verificar Configuraci√≥n Firebase</h3>
            <p>Ingresa TU configuraci√≥n de Firebase:</p>
            <div class="code-block">
apiKey: <input type="text" id="apiKey" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="AIzaSy..."><br>
authDomain: <input type="text" id="authDomain" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="tu-proyecto.firebaseapp.com"><br>
projectId: <input type="text" id="projectId" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="tu-proyecto"><br>
storageBucket: <input type="text" id="storageBucket" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="tu-proyecto.appspot.com"><br>
messagingSenderId: <input type="text" id="messagingSenderId" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="123456789012"><br>
appId: <input type="text" id="appId" style="width: 100%; padding: 8px; margin: 5px 0; border: none; border-radius: 4px;" placeholder="1:123456789012:web:abc123">
            </div>
            <button class="button" onclick="testFirebase()">üîç Probar Conexi√≥n Firebase</button>
            <div class="status" id="firebaseStatus"></div>
        </div>
        
        <div class="step">
            <div class="step-number">2</div>
            <h3>Crear Usuario Administrador</h3>
            <p>Este usuario podr√° acceder al panel admin:</p>
            <input type="email" id="adminEmail" placeholder="admin@tudominio.com" style="width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px;">
            <input type="password" id="adminPassword" placeholder="Contrase√±a segura" style="width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px;">
            <button class="button" onclick="createAdmin()">üëë Crear Usuario Admin</button>
            <div class="status" id="adminStatus"></div>
        </div>
        
        <div class="step">
            <div class="step-number">3</div>
            <h3>Inicializar Base de Datos</h3>
            <p>Crear colecciones y datos iniciales:</p>
            <button class="button" onclick="initializeDB()">üöÄ Inicializar Base de Datos</button>
            <div class="status" id="dbStatus"></div>
        </div>
        
        <div class="step">
            <div class="step-number">4</div>
            <h3>Probar Sistema</h3>
            <button class="button success" onclick="window.open('/', '_blank')">üì± Abrir App Cliente</button>
            <button class="button success" onclick="window.open('/admin.html', '_blank')">üñ•Ô∏è Abrir Panel Admin</button>
        </div>
    </div>

    <script>
        let firebaseApp = null;
        let db = null;
        let auth = null;
        
        async function testFirebase() {
            const status = document.getElementById('firebaseStatus');
            status.className = 'status';
            status.textContent = 'Probando conexi√≥n...';
            
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                storageBucket: document.getElementById('storageBucket').value.trim(),
                messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };
            
            // Validar que todos los campos est√©n completos
            for (const [key, value] of Object.entries(config)) {
                if (!value) {
                    status.className = 'status error show';
                    status.textContent = `‚ùå Falta completar: ${key}`;
                    return;
                }
            }
            
            try {
                // Si ya hay una app de Firebase, elim√≠nala
                if (firebaseApp) {
                    try { firebaseApp.delete(); } catch(e) {}
                }
                
                // Inicializar Firebase
                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Probar conexi√≥n con Firestore
                const testRef = db.collection('test').doc('connection');
                await testRef.set({ test: new Date().toISOString() });
                await testRef.delete();
                
                status.className = 'status success show';
                status.textContent = '‚úÖ Firebase conectado correctamente!';
                
                // Guardar configuraci√≥n en localStorage para otros archivos
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // Actualizar firebase-config.js autom√°ticamente
                updateFirebaseConfigFile(config);
                
            } catch (error) {
                status.className = 'status error show';
                status.textContent = `‚ùå Error: ${error.message}`;
                console.error('Firebase error:', error);
            }
        }
        
        function updateFirebaseConfigFile(config) {
            // Crear contenido para firebase-config.js
            const content = `// CONFIGURACI√ìN FIREBASE - ${new Date().toLocaleDateString()}
const firebaseConfig = ${JSON.stringify(config, null, 4)};

// Inicializar Firebase
try {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase inicializado correctamente");
} catch (error) {
    console.error("Error inicializando Firebase:", error);
}

// Referencias globales
const db = firebase.firestore();
const auth = firebase.auth();

// Funci√≥n para verificar conexi√≥n
async function testFirebaseConnection() {
    try {
        const settingsRef = db.collection('settings').doc('config');
        const doc = await settingsRef.get();
        return doc.exists;
    } catch (error) {
        console.error("Error conectando a Firebase:", error);
        return false;
    }
}

// Configuraci√≥n inicial si no existe
async function initializeFirebaseData() {
    try {
        const settingsRef = db.collection('settings').doc('config');
        const settingsDoc = await settingsRef.get();
        
        if (!settingsDoc.exists) {
            await settingsRef.set({
                nombre_local: "EL TACHI Rotiser√≠a",
                horarios_por_dia: {
                    lunes: "11:00 - 23:00",
                    martes: "11:00 - 23:00",
                    mi√©rcoles: "11:00 - 23:00",
                    jueves: "11:00 - 23:00",
                    viernes: "11:00 - 00:00",
                    s√°bado: "11:00 - 00:00",
                    domingo: "11:00 - 23:00"
                },
                abierto: true,
                mensaje_cerrado: "Lo sentimos, estamos cerrados en este momento. Volvemos ma√±ana a las 11:00.",
                precio_envio: 300,
                tiempo_base_estimado: 30,
                retiro_habilitado: true,
                colores_marca: { azul: "#1e40af", amarillo: "#f59e0b" },
                telefono_whatsapp: "",
                api_key_gemini: ""
            });
        }
        
        return true;
    } catch (error) {
        console.error("Error inicializando datos:", error);
        return false;
    }
}

// Exportar
window.db = db;
window.auth = auth;
window.testFirebaseConnection = testFirebaseConnection;
window.initializeFirebaseData = initializeFirebaseData;`;
            
            // Crear un blob y descargar el archivo
            const blob = new Blob([content], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'firebase-config-fixed.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Archivo firebase-config-fixed.js generado. \n\nReemplaza el archivo firebase-config.js con este.');
        }
        
        async function createAdmin() {
            const status = document.getElementById('adminStatus');
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!email || !password) {
                status.className = 'status error show';
                status.textContent = '‚ùå Completa email y contrase√±a';
                return;
            }
            
            if (!firebaseApp) {
                status.className = 'status error show';
                status.textContent = '‚ùå Primero prueba la conexi√≥n Firebase (Paso 1)';
                return;
            }
            
            status.className = 'status';
            status.textContent = 'Creando usuario...';
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Actualizar perfil
                await userCredential.user.updateProfile({
                    displayName: 'Administrador EL TACHI'
                });
                
                status.className = 'status success show';
                status.textContent = `‚úÖ Usuario creado: ${email}`;
                
                // Cerrar sesi√≥n para seguridad
                setTimeout(() => auth.signOut(), 2000);
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    status.className = 'status success show';
                    status.textContent = '‚úÖ El usuario ya existe. Perfecto!';
                } else {
                    status.className = 'status error show';
                    status.textContent = `‚ùå Error: ${error.message}`;
                }
            }
        }
        
        async function initializeDB() {
            const status = document.getElementById('dbStatus');
            
            if (!firebaseApp) {
                status.className = 'status error show';
                status.textContent = '‚ùå Primero prueba la conexi√≥n Firebase (Paso 1)';
                return;
            }
            
            status.className = 'status';
            status.textContent = 'Inicializando...';
            
            try {
                // Crear configuraci√≥n
                const settingsRef = db.collection('settings').doc('config');
                const settingsDoc = await settingsRef.get();
                
                if (!settingsDoc.exists) {
                    await settingsRef.set({
                        nombre_local: "EL TACHI Rotiser√≠a",
                        horarios_por_dia: {
                            lunes: "11:00 - 23:00",
                            martes: "11:00 - 23:00",
                            mi√©rcoles: "11:00 - 23:00",
                            jueves: "11:00 - 23:00",
                            viernes: "11:00 - 00:00",
                            s√°bado: "11:00 - 00:00",
                            domingo: "11:00 - 23:00"
                        },
                        abierto: true,
                        mensaje_cerrado: "Lo sentimos, estamos cerrados en este momento. Volvemos ma√±ana a las 11:00.",
                        precio_envio: 300,
                        tiempo_base_estimado: 30,
                        retiro_habilitado: true,
                        colores_marca: { azul: "#1e40af", amarillo: "#f59e0b" },
                        telefono_whatsapp: "",
                        api_key_gemini: ""
                    });
                    status.textContent += '\n‚úÖ Configuraci√≥n creada';
                }
                
                // Crear productos de ejemplo
                const products = [
                    {
                        id: "hamburguesa-clasica",
                        nombre: "Hamburguesa Cl√°sica",
                        descripcion: "Carne 150g, queso, lechuga, tomate, cebolla y aderezo especial",
                        precio: 1200,
                        disponible: true,
                        categoria: "hamburguesas",
                        aderezos_disponibles: ["Sin cebolla", "Sin tomate", "Extra queso", "Picante"],
                        precios_extra_aderezos: { "Extra queso": 100, "Picante": 50 }
                    },
                    {
                        id: "papas-fritas",
                        nombre: "Papas Fritas",
                        descripcion: "Porci√≥n grande con sal y perejil",
                        precio: 800,
                        disponible: true,
                        categoria: "acompa√±amientos",
                        aderezos_disponibles: ["Con cheddar", "Con bacon"],
                        precios_extra_aderezos: { "Con cheddar": 150, "Con bacon": 200 }
                    }
                ];
                
                for (const product of products) {
                    await db.collection('products').doc(product.id).set(product);
                }
                status.textContent += '\n‚úÖ Productos creados';
                
                // Crear categor√≠as
                const categories = [
                    { id: "hamburguesas", nombre: "Hamburguesas", orden: 1 },
                    { id: "acompa√±amientos", nombre: "Acompa√±amientos", orden: 2 },
                    { id: "bebidas", nombre: "Bebidas", orden: 3 }
                ];
                
                for (const category of categories) {
                    await db.collection('categories').doc(category.id).set(category);
                }
                status.textContent += '\n‚úÖ Categor√≠as creadas';
                
                // Contador de pedidos
                await db.collection('counters').doc('orders').set({ lastNumber: 0 });
                status.textContent += '\n‚úÖ Contador creado';
                
                status.className = 'status success show';
                status.textContent += '\n\nüéâ ¬°Base de datos inicializada exitosamente!';
                
            } catch (error) {
                status.className = 'status error show';
                status.textContent = `‚ùå Error: ${error.message}`;
                console.error('DB init error:', error);
            }
        }
    </script>
</body>
</html>
